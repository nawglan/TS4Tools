name: Code Quality & Analyzers

on:
  push:
    branches: [ main, develop, 'feature/**', 'bugfix/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  code-quality-and-analyzers:
    name: Code Quality & Analyzers
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('Directory.Packages.props', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore TS4Tools.sln --verbosity normal

    - name: Build solution
      run: |
        Write-Host "üî® Building solution to ensure dependencies are resolved..."
        dotnet build TS4Tools.sln --no-restore --verbosity minimal --configuration Debug
        if ($LASTEXITCODE -ne 0) {
          Write-Error "‚ùå Build failed! Cannot proceed with analyzer checks."
          exit 1
        }

        Write-Host "‚úÖ Build successful! Code formatting is enforced via pre-commit hooks."

    - name: Run .NET analyzers
      run: |
        Write-Host "üîç Running .NET code analyzers..."
        Write-Host "‚ÑπÔ∏è This includes Microsoft.CodeAnalysis.NetAnalyzers and SonarAnalyzer.CSharp"

        # Build with analyzer warnings treated as errors (no-restore since we already built above)
        dotnet build TS4Tools.sln --no-restore --configuration Release --verbosity normal --property:TreatWarningsAsErrors=true --property:WarningsAsErrors=""

        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Error "‚ùå Code analyzer warnings detected!"
          Write-Host ""
          Write-Host "üîß To see detailed analyzer output:"
          Write-Host "   dotnet build --verbosity normal"
          Write-Host ""
          Write-Host "üí° Common fixes:"
          Write-Host "   ‚Ä¢ Make unused private members internal or remove them"
          Write-Host "   ‚Ä¢ Add null checks where required"
          Write-Host "   ‚Ä¢ Follow naming conventions (PascalCase for public, camelCase for private)"
          Write-Host "   ‚Ä¢ Add XML documentation for public APIs"
          Write-Host ""
          exit 1
        }

        Write-Host "‚úÖ All analyzer checks passed!"

    - name: Run EditorConfig validation
      run: |
        Write-Host "üîç Validating EditorConfig compliance..."

        # Check if .editorconfig exists
        if (-not (Test-Path ".editorconfig")) {
          Write-Warning "‚ö†Ô∏è No .editorconfig file found in repository root"
        } else {
          Write-Host "‚úÖ .editorconfig file found"

          # Show EditorConfig settings being applied
          Write-Host "‚ÑπÔ∏è EditorConfig settings:"
          Get-Content ".editorconfig" | Select-Object -First 20
        }

    - name: Summary
      if: success()
      run: |
        Write-Host ""
        Write-Host "üéâ All code quality checks passed!" -ForegroundColor Green
        Write-Host ""
        Write-Host "‚úÖ Code formatting: PASSED" -ForegroundColor Green
        Write-Host "‚úÖ .NET analyzers: PASSED" -ForegroundColor Green
        Write-Host "‚úÖ EditorConfig: VALIDATED" -ForegroundColor Green
        Write-Host ""
        Write-Host "üöÄ Code is ready for review and merge!"

  # Optional: Create a summary comment on PRs
  pr-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: code-quality-and-analyzers
    if: github.event_name == 'pull_request' && success()

    steps:
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ‚úÖ Code Quality Check Passed

            All code formatting and analyzer checks have passed successfully!

            - ‚úÖ **Code Formatting**: All files properly formatted
            - ‚úÖ **.NET Analyzers**: No warnings detected
            - ‚úÖ **EditorConfig**: Configuration validated

            Your code follows the project's quality standards. Great job! üéâ`
          })
