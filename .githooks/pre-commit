#!/bin/bash

# TS4Tools Pre-Commit Hook
# Automatically formats code before commits

echo "ğŸ” Running pre-commit checks..."

# Check if dotnet is available
if ! command -v dotnet &> /dev/null; then
    echo "âŒ dotnet CLI not found. Please install .NET SDK."
    exit 1
fi

# Get the root directory of the git repository
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Check if solution file exists
if [ ! -f "TS4Tools.sln" ]; then
    echo "âŒ TS4Tools.sln not found in repository root."
    exit 1
fi

echo "ğŸ“ Repository root: $REPO_ROOT"

# Format only staged files
echo "ğŸ”§ Formatting staged files..."

# Get list of staged C# files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cs|csproj|props|targets)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "â„¹ï¸  No C# files staged for commit."
else
    echo "ğŸ“ Staged C# files:"
    echo "$STAGED_FILES" | sed 's/^/  /'

    # Run dotnet format on the solution
    echo "ğŸ¨ Running dotnet format..."
    if dotnet format TS4Tools.sln --verbosity minimal --include $(echo "$STAGED_FILES" | tr '\n' ',' | sed 's/,$//'); then
        echo "âœ… Code formatting completed successfully."

        # Re-stage any files that were formatted
        echo "ğŸ“‹ Re-staging formatted files..."
        echo "$STAGED_FILES" | xargs git add
    else
        echo "âŒ Code formatting failed!"
        echo ""
        echo "ğŸ”§ To fix manually:"
        echo "   dotnet format TS4Tools.sln"
        echo ""
        echo "ğŸ’¡ To skip this check (not recommended):"
        echo "   git commit --no-verify"
        exit 1
    fi
fi

# Optional: Run quick build check to catch compilation errors
echo "ğŸ”¨ Running quick build check..."
if dotnet build TS4Tools.sln --verbosity quiet --configuration Debug --no-restore > /dev/null 2>&1; then
    echo "âœ… Build check passed."
else
    echo "âš ï¸  Build check failed - there may be compilation issues."
    echo "   This won't block the commit, but consider running 'dotnet build' to check."
fi

echo "ğŸ‰ Pre-commit checks completed successfully!"
echo ""
